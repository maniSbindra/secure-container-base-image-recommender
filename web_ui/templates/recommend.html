{% extends "base.html" %}

{% block title %}Recommend Image - Container Image Recommendations and Analysis{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-search text-primary"></i>
            Find Your Perfect Base Image
        </h1>
        <p class="lead text-muted">
            Tell us about your requirements and we'll recommend the best container base images
        </p>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" id="recommendationTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="requirements-tab" data-bs-toggle="tab"
                        data-bs-target="#requirements-pane" type="button" role="tab">
                    <i class="bi bi-gear"></i> By Requirements
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="image-analysis-tab" data-bs-toggle="tab"
                        data-bs-target="#image-analysis-pane" type="button" role="tab">
                    <i class="bi bi-image"></i> Analyze Existing Image
                </button>
            </li>
        </ul>
    </div>
</div>

<div class="row">
    <!-- Tab Content -->
    <div class="tab-content" id="recommendationTabContent">
        <!-- Requirements Tab -->
        <div class="tab-pane fade show active" id="requirements-pane" role="tabpanel">
            <div class="row">
                <!-- Recommendation Form -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-gear"></i> Requirements</h5>
                        </div>
                        <div class="card-body">
                            <form id="recommendationForm">
                                <!-- Language -->
                                <div class="mb-3">
                                    <label for="language" class="form-label">Programming Language *</label>
                                    <select class="form-select" id="language" required>
                                        <option value="">Select Language</option>
                                        <option value="python">Python</option>
                                        <option value="node">Node.js</option>
                                        <option value="java">Java</option>
                                        <option value="go">Go</option>
                                        <option value="dotnet">.NET</option>
                                        <option value="php">PHP</option>
                                        <option value="ruby">Ruby</option>
                                    </select>
                                </div>

                                <!-- Version -->
                                <div class="mb-3">
                                    <label for="version" class="form-label">Version (Optional)</label>
                                    <input type="text" class="form-control" id="version"
                                           placeholder="e.g., 3.12, 18, 17">
                                    <div class="form-text">Leave empty for any version</div>
                                </div>

                                <!-- Packages -->
                                <div class="mb-3">
                                    <label for="packages" class="form-label">Required Packages (Optional)</label>
                                    <textarea class="form-control" id="packages" rows="3"
                                              placeholder="flask&#10;pandas&#10;numpy"></textarea>
                                    <div class="form-text">Enter package names, one per line. We'll check if they're pre-installed or available via package managers.</div>
                                </div>

                                <!-- Size Preference -->
                                <div class="mb-3">
                                    <label for="sizePreference" class="form-label">Size Preference</label>
                                    <select class="form-select" id="sizePreference">
                                        <option value="minimal">Minimal (Smallest possible)</option>
                                        <option value="balanced" selected>Balanced (Good compromise)</option>
                                        <option value="full">Full (Complete features)</option>
                                    </select>
                                </div>

                                <!-- Security Level -->
                                <div class="mb-3">
                                    <label for="securityLevel" class="form-label">Security Level</label>
                                    <select class="form-select" id="securityLevel">
                                        <option value="maximum">Maximum (Zero vulnerabilities)</option>
                                        <option value="high" selected>High (No critical/high vulns)</option>
                                        <option value="standard">Standard (Limited vulnerabilities)</option>
                                    </select>
                                </div>

                                <!-- Advanced Options (Collapsible) -->
                                <div class="mb-3">
                                    <button class="btn btn-outline-secondary btn-sm w-100" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#advancedOptions">
                                        <i class="bi bi-gear"></i> Advanced Options
                                    </button>

                                    <div class="collapse mt-2" id="advancedOptions">
                                        <div class="mb-2">
                                            <label for="maxVulns" class="form-label">Max Total Vulnerabilities</label>
                                            <input type="number" class="form-control" id="maxVulns" value="10" min="0">
                                        </div>
                                        <div class="mb-2">
                                            <label for="maxCritical" class="form-label">Max Critical Vulnerabilities</label>
                                            <input type="number" class="form-control" id="maxCritical" value="0" min="0">
                                        </div>
                                        <div class="mb-2">
                                            <label for="maxHigh" class="form-label">Max High Vulnerabilities</label>
                                            <input type="number" class="form-control" id="maxHigh" value="0" min="0">
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-search"></i> Get Recommendations
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Results -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-list-check"></i> Recommendations</h5>
                            <div class="loading-spinner" id="loadingSpinner">
                                <div class="spinner-border spinner-border-sm text-light" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Initial state -->
                            <div id="initialState" class="text-center py-5">
                                <i class="bi bi-arrow-left-circle display-1 text-muted"></i>
                                <h5 class="text-muted mt-3">Fill out the form to get recommendations</h5>
                                <p class="text-muted">We'll analyze your requirements and suggest the best container base images</p>
                            </div>

                            <!-- Results container -->
                            <div id="resultsContainer" style="display: none;">
                                <!-- Requirements summary -->
                                <div id="requirementsSummary" class="alert alert-info mb-4" style="display: none;">
                                    <!-- Will be populated by JavaScript -->
                                </div>

                                <!-- Recommendations list -->
                                <div id="recommendationsList">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Error state -->
                            <div id="errorState" class="alert alert-danger" style="display: none;">
                                <!-- Will be populated by JavaScript -->
                            </div>

                            <!-- No results state -->
                            <div id="noResultsState" style="display: none;">
                                <div class="text-center py-4">
                                    <i class="bi bi-search display-1 text-warning"></i>
                                    <h5 class="text-warning mt-3">No matching images found</h5>
                                    <p class="text-muted">Try adjusting your requirements:</p>
                                    <ul class="text-muted text-start">
                                        <li>Increase maximum vulnerabilities allowed</li>
                                        <li>Remove version constraints</li>
                                        <li>Change security level to "Standard"</li>
                                        <li>Select a different size preference</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Analysis Tab -->
        <div class="tab-pane fade" id="image-analysis-pane" role="tabpanel">
            <div class="row">
                <!-- Image Analysis Form -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-image"></i> Analyze Image</h5>
                        </div>
                        <div class="card-body">
                            <form id="imageAnalysisForm">
                                <!-- Image Name -->
                                <div class="mb-3">
                                    <label for="imageName" class="form-label">Container Image *</label>
                                    <input type="text" class="form-control" id="imageName" required
                                           placeholder="e.g., python:3.12-slim, node:18-alpine, ubuntu:22.04">
                                    <div class="form-text">
                                        Enter the full image name with tag. If no tag is specified, ":latest" will be used.
                                    </div>
                                </div>

                                <!-- Analysis Options -->
                                <div class="mb-3">
                                    <label class="form-label">Analysis Options</label>
                                    <div class="form-text mb-2">Configure how to use the analysis results for recommendations:</div>
                                </div>

                                <!-- Size Preference -->
                                <div class="mb-3">
                                    <label for="sizePreferenceAnalysis" class="form-label">Size Preference</label>
                                    <select class="form-select" id="sizePreferenceAnalysis">
                                        <option value="minimal">Minimal (Smallest possible)</option>
                                        <option value="balanced" selected>Balanced (Good compromise)</option>
                                        <option value="full">Full (Complete features)</option>
                                    </select>
                                </div>

                                <!-- Security Level -->
                                <div class="mb-3">
                                    <label for="securityLevelAnalysis" class="form-label">Security Level</label>
                                    <select class="form-select" id="securityLevelAnalysis">
                                        <option value="maximum">Maximum (Zero vulnerabilities)</option>
                                        <option value="high" selected>High (No critical/high vulns)</option>
                                        <option value="standard">Standard (Limited vulnerabilities)</option>
                                    </select>
                                </div>

                                <!-- Advanced Options (Collapsible) -->
                                <div class="mb-3">
                                    <button class="btn btn-outline-secondary btn-sm w-100" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#advancedOptionsAnalysis">
                                        <i class="bi bi-gear"></i> Advanced Options
                                    </button>

                                    <div class="collapse mt-2" id="advancedOptionsAnalysis">
                                        <div class="mb-2">
                                            <label for="maxVulnsAnalysis" class="form-label">Max Total Vulnerabilities</label>
                                            <input type="number" class="form-control" id="maxVulnsAnalysis" value="10" min="0">
                                        </div>
                                        <div class="mb-2">
                                            <label for="maxCriticalAnalysis" class="form-label">Max Critical Vulnerabilities</label>
                                            <input type="number" class="form-control" id="maxCriticalAnalysis" value="0" min="0">
                                        </div>
                                        <div class="mb-2">
                                            <label for="maxHighAnalysis" class="form-label">Max High Vulnerabilities</label>
                                            <input type="number" class="form-control" id="maxHighAnalysis" value="0" min="0">
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-success w-100">
                                    <i class="bi bi-play-circle"></i> Analyze & Get Recommendations
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Analysis Info Card -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-info-circle"></i> How it works</h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-2">
                                This feature analyzes your existing container image to:
                            </p>
                            <ul class="small text-muted mb-0">
                                <li>Detect programming languages and versions</li>
                                <li>Extract installed system packages</li>
                                <li>Identify package managers</li>
                                <li>Find compatible base images</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Results -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-list-check"></i> Analysis & Recommendations</h5>
                            <div class="loading-spinner" id="loadingSpinnerAnalysis">
                                <div class="spinner-border spinner-border-sm text-light" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Initial state -->
                            <div id="initialStateAnalysis" class="text-center py-5">
                                <i class="bi bi-arrow-left-circle display-1 text-muted"></i>
                                <h5 class="text-muted mt-3">Enter an image name to analyze</h5>
                                <p class="text-muted">We'll analyze the image and recommend similar base images from our database</p>
                            </div>

                            <!-- Results container -->
                            <div id="resultsContainerAnalysis" style="display: none;">
                                <!-- Analysis summary -->
                                <div id="analysisSummary" class="alert alert-success mb-4" style="display: none;">
                                    <!-- Will be populated by JavaScript -->
                                </div>

                                <!-- Requirements summary -->
                                <div id="requirementsSummaryAnalysis" class="alert alert-info mb-4" style="display: none;">
                                    <!-- Will be populated by JavaScript -->
                                </div>

                                <!-- Recommendations list -->
                                <div id="recommendationsListAnalysis">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Error state -->
                            <div id="errorStateAnalysis" class="alert alert-danger" style="display: none;">
                                <!-- Will be populated by JavaScript -->
                            </div>

                            <!-- No results state -->
                            <div id="noResultsStateAnalysis" style="display: none;">
                                <!-- Analysis details for no results -->
                                <div id="noResultsAnalysisDetails" style="display: none;"></div>

                                <div class="text-center py-4">
                                    <i class="bi bi-search display-1 text-warning"></i>
                                    <h5 class="text-warning mt-3">No matching images found</h5>
                                    <p class="text-muted">Your image was analyzed successfully, but no compatible recommendations were found. Try adjusting your preferences:</p>
                                    <ul class="text-muted text-start">
                                        <li>Increase maximum vulnerabilities allowed</li>
                                        <li>Change security level to "Standard"</li>
                                        <li>Select a different size preference</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Original recommendation form handler
document.getElementById('recommendationForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Show loading state
    const loadingSpinner = document.getElementById('loadingSpinner');
    const initialState = document.getElementById('initialState');
    const resultsContainer = document.getElementById('resultsContainer');
    const errorState = document.getElementById('errorState');
    const noResultsState = document.getElementById('noResultsState');

    showLoading(loadingSpinner);
    initialState.style.display = 'none';
    resultsContainer.style.display = 'none';
    errorState.style.display = 'none';
    noResultsState.style.display = 'none';

    // Collect form data
    const formData = {
        language: document.getElementById('language').value,
        version: document.getElementById('version').value,
        packages: document.getElementById('packages').value
            .split('\n')
            .map(p => p.trim())
            .filter(p => p.length > 0),
        size_preference: document.getElementById('sizePreference').value,
        security_level: document.getElementById('securityLevel').value,
        max_vulnerabilities: parseInt(document.getElementById('maxVulns').value),
        max_critical_vulnerabilities: parseInt(document.getElementById('maxCritical').value),
        max_high_vulnerabilities: parseInt(document.getElementById('maxHigh').value)
    };

    try {
        const response = await fetch('/api/recommend', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        hideLoading(loadingSpinner);

        if (data.success) {
            if (data.recommendations.length > 0) {
                displayRecommendations(data.recommendations, data.requirement);
                resultsContainer.style.display = 'block';
            } else {
                noResultsState.style.display = 'block';
            }
        } else {
            displayError(data.error);
        }

    } catch (error) {
        hideLoading(loadingSpinner);
        displayError('Failed to get recommendations: ' + error.message);
    }
});

// New image analysis form handler
document.getElementById('imageAnalysisForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Show loading state
    const loadingSpinner = document.getElementById('loadingSpinnerAnalysis');
    const initialState = document.getElementById('initialStateAnalysis');
    const resultsContainer = document.getElementById('resultsContainerAnalysis');
    const errorState = document.getElementById('errorStateAnalysis');
    const noResultsState = document.getElementById('noResultsStateAnalysis');

    showLoading(loadingSpinner);
    initialState.style.display = 'none';
    resultsContainer.style.display = 'none';
    errorState.style.display = 'none';
    noResultsState.style.display = 'none';

    // Collect form data
    const formData = {
        image_name: document.getElementById('imageName').value.trim(),
        size_preference: document.getElementById('sizePreferenceAnalysis').value,
        security_level: document.getElementById('securityLevelAnalysis').value,
        max_vulnerabilities: parseInt(document.getElementById('maxVulnsAnalysis').value),
        max_critical_vulnerabilities: parseInt(document.getElementById('maxCriticalAnalysis').value),
        max_high_vulnerabilities: parseInt(document.getElementById('maxHighAnalysis').value)
    };

    try {
        const response = await fetch('/api/analyze-and-recommend', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        hideLoading(loadingSpinner);

        if (data.success) {
            if (data.recommendations.length > 0) {
                displayAnalysisResults(data.analyzed_image, data.analysis, data.recommendations, data.requirement);
                resultsContainer.style.display = 'block';
            } else {
                // Even with no recommendations, show the analysis details
                displayAnalysisWithNoRecommendations(data.analyzed_image, data.analysis, data.requirement);
                noResultsState.style.display = 'block';
            }
        } else {
            // Check if this is an image not found error
            if (data.image_not_found && data.suggested_action === 'scan_image') {
                displayImageNotFoundError(data.error, formData.image_name);
            } else {
                displayErrorAnalysis(data.error);
            }
        }

    } catch (error) {
        hideLoading(loadingSpinner);
        displayErrorAnalysis('Failed to analyze image: ' + error.message);
    }
});

function displayAnalysisResults(analyzedImage, analysis, recommendations, requirement) {
    // Display analysis summary
    const analysisDiv = document.getElementById('analysisSummary');
    const languagesText = analysis.languages.map(l => `${l.language} ${l.version || '(version unknown)'}`).join(', ');

    // Get vulnerability info from analysis
    const vulns = analysis.vulnerabilities || {};
    const vulnBadge = getVulnerabilityBadge(vulns);

    analysisDiv.innerHTML = `
        <h6><i class="bi bi-check-circle"></i> Analysis Complete</h6>
        <strong>Analyzed Image:</strong> ${analyzedImage}<br>
        <strong>Detected Languages:</strong> ${languagesText}<br>
        <strong>System Packages:</strong> ${analysis.system_packages_count} packages<br>
        <strong>Package Managers:</strong> ${analysis.package_managers_count} detected<br>
        <strong>Total Packages Found:</strong> ${analysis.total_packages}<br>
        <strong>Image Size:</strong> ${formatBytes(analysis.size_bytes || 0)}<br>
        <strong>Security Status:</strong> ${vulnBadge}
    `;
    analysisDiv.style.display = 'block';

    // Display requirements summary (derived from analysis)
    const summaryDiv = document.getElementById('requirementsSummaryAnalysis');
    summaryDiv.innerHTML = `
        <h6><i class="bi bi-info-circle"></i> Derived Requirements</h6>
        <strong>Primary Language:</strong> ${requirement.language} ${requirement.version || '(any version)'}<br>
        ${requirement.packages.length > 0 ? `<strong>Packages (first 20):</strong> ${requirement.packages.join(', ')}<br>` : ''}
        <strong>Size:</strong> ${requirement.size_preference} •
        <strong>Security:</strong> ${requirement.security_level}
    `;
    summaryDiv.style.display = 'block';

    // Display recommendations (reuse existing function)
    const listDiv = document.getElementById('recommendationsListAnalysis');
    listDiv.innerHTML = recommendations.map((rec, index) => `
        <div class="recommendation-card card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-primary me-2">#${index + 1}</span>
                            <h6 class="mb-0">${rec.image_name}</h6>
                        </div>

                        <p class="text-muted mb-2">
                            ${rec.reasoning.join(' • ')}
                            ${rec.total_required_packages > 0 ?
                                `<br><small><i class="bi bi-box"></i> Packages: ${rec.packages_found}/${rec.total_required_packages} pre-installed</small>`
                                : ''
                            }
                        </p>

                        <div class="row g-2">
                            <div class="col-sm-6">
                                <small class="text-muted">
                                    <i class="bi bi-hdd"></i>
                                    Size: ${formatBytes(rec.size_bytes)}
                                </small>
                            </div>
                            <div class="col-sm-6">
                                <small class="text-muted">
                                    <i class="bi bi-code"></i>
                                    ${rec.languages.map(l => l.language + ' ' + (l.version || '')).join(', ')}
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 text-md-end">
                        <div class="mb-2">
                            <span class="badge score-badge ${getScoreClass(rec.score)}">
                                ${(rec.score * 100).toFixed(0)}% Match
                            </span>
                        </div>

                        <div class="mb-2">
                            ${getVulnerabilityBadge(rec.vulnerabilities)}
                        </div>

                        <div class="row g-2">
                            <div class="col-12">
                                <button class="btn btn-outline-primary btn-sm w-100"
                                        onclick="copyDockerCommand('${rec.image_name}')">
                                    <i class="bi bi-clipboard"></i> Copy Docker Command
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-info btn-sm w-100"
                                        onclick="showImageDetails('${rec.image_name}')"
                                        type="button">
                                    <i class="bi bi-eye"></i> View Details
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-success btn-sm w-100"
                                        onclick="compareImages('${analyzedImage}', '${rec.image_name}')"
                                        type="button">
                                    <i class="bi bi-arrow-left-right"></i> Compare
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed scores -->
                <div class="mt-3">
                    <div class="row g-2">
                        <div class="col-sm-6 col-lg-3">
                            <small class="text-muted">Language Match</small><br>
                            <span class="badge ${rec.language_match ? 'bg-success' : 'bg-danger'}">
                                ${rec.language_match ? 'Yes' : 'No'}
                            </span>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <small class="text-muted">Version Match</small><br>
                            <span class="badge ${rec.version_match ? 'bg-success' : 'bg-warning'}">
                                ${rec.version_match ? 'Yes' : 'Compatible'}
                            </span>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <small class="text-muted">Package Score</small><br>
                            <span class="badge bg-info" ${rec.total_required_packages > 0 ? `title="${rec.packages_found} out of ${rec.total_required_packages} required packages are pre-installed"` : 'title="No specific packages required"'}>
                                ${(rec.package_compatibility * 100).toFixed(0)}%${rec.total_required_packages > 0 ? ` (${rec.packages_found}/${rec.total_required_packages})` : ''}
                            </span>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <small class="text-muted">Security Score</small><br>
                            <span class="badge bg-success">
                                ${(rec.security_score * 100).toFixed(0)}%
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function displayRecommendations(recommendations, requirement) {
    // Display requirements summary
    const summaryDiv = document.getElementById('requirementsSummary');
    summaryDiv.innerHTML = `
        <h6><i class="bi bi-info-circle"></i> Your Requirements</h6>
        <strong>Language:</strong> ${requirement.language} ${requirement.version || '(any version)'}<br>
        ${requirement.packages.length > 0 ? `<strong>Packages:</strong> ${requirement.packages.join(', ')}<br>` : ''}
        <strong>Size:</strong> ${requirement.size_preference} •
        <strong>Security:</strong> ${requirement.security_level}
    `;
    summaryDiv.style.display = 'block';

    // Display recommendations
    const listDiv = document.getElementById('recommendationsList');
    listDiv.innerHTML = recommendations.map((rec, index) => `
        <div class="recommendation-card card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-primary me-2">#${index + 1}</span>
                            <h6 class="mb-0">${rec.image_name}</h6>
                        </div>

                        <p class="text-muted mb-2">
                            ${rec.reasoning.join(' • ')}
                            ${rec.total_required_packages > 0 ?
                                `<br><small><i class="bi bi-box"></i> Packages: ${rec.packages_found}/${rec.total_required_packages} pre-installed</small>`
                                : ''
                            }
                        </p>

                        <div class="row g-2">
                            <div class="col-sm-6">
                                <small class="text-muted">
                                    <i class="bi bi-hdd"></i>
                                    Size: ${formatBytes(rec.size_bytes)}
                                </small>
                            </div>
                            <div class="col-sm-6">
                                <small class="text-muted">
                                    <i class="bi bi-code"></i>
                                    ${rec.languages.map(l => l.language + ' ' + (l.version || '')).join(', ')}
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 text-md-end">
                        <div class="mb-2">
                            <span class="badge score-badge ${getScoreClass(rec.score)}">
                                ${(rec.score * 100).toFixed(0)}% Match
                            </span>
                        </div>

                        <div class="mb-2">
                            ${getVulnerabilityBadge(rec.vulnerabilities)}
                        </div>

                        <div class="row g-2">
                            <div class="col-12">
                                <button class="btn btn-outline-primary btn-sm w-100"
                                        onclick="copyDockerCommand('${rec.image_name}')">
                                    <i class="bi bi-clipboard"></i> Copy Docker Command
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-info btn-sm w-100"
                                        onclick="showImageDetails('${rec.image_name}')"
                                        type="button">
                                    <i class="bi bi-eye"></i> View Details
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-secondary btn-sm w-100"
                                        onclick="compareImages('${rec.image_name}')"
                                        type="button">
                                    <i class="bi bi-arrow-left-right"></i> Compare
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed scores (always visible) -->
                <div class="mt-3">
                    <div class="row g-2">
                        <div class="col-sm-6 col-lg-3">
                            <small class="text-muted">Language Match</small><br>
                            <span class="badge ${rec.language_match ? 'bg-success' : 'bg-danger'}">
                                ${rec.language_match ? 'Yes' : 'No'}
                            </span>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <small class="text-muted">Version Match</small><br>
                            <span class="badge ${rec.version_match ? 'bg-success' : 'bg-warning'}">
                                ${rec.version_match ? 'Yes' : 'Compatible'}
                            </span>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <small class="text-muted">Package Score</small><br>
                            <span class="badge bg-info" ${rec.total_required_packages > 0 ? `title="${rec.packages_found} out of ${rec.total_required_packages} required packages are pre-installed"` : 'title="No specific packages required"'}>
                                ${(rec.package_compatibility * 100).toFixed(0)}%${rec.total_required_packages > 0 ? ` (${rec.packages_found}/${rec.total_required_packages})` : ''}
                            </span>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <small class="text-muted">Security Score</small><br>
                            <span class="badge bg-success">
                                ${(rec.security_score * 100).toFixed(0)}%
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function displayError(error) {
    const errorDiv = document.getElementById('errorState');
    errorDiv.innerHTML = `
        <h6><i class="bi bi-exclamation-triangle"></i> Error</h6>
        ${error}
    `;
    errorDiv.style.display = 'block';
}

function displayErrorAnalysis(error) {
    const errorDiv = document.getElementById('errorStateAnalysis');
    errorDiv.innerHTML = `
        <h6><i class="bi bi-exclamation-triangle"></i> Error</h6>
        ${error}
    `;
    errorDiv.style.display = 'block';
}

function displayImageNotFoundError(error, imageName) {
    const errorDiv = document.getElementById('errorStateAnalysis');
    errorDiv.innerHTML = `
        <h6><i class="bi bi-exclamation-circle text-warning"></i> Image Not Found</h6>
        <p>${error}</p>
        <div class="mt-3">
            <h6><i class="bi bi-lightbulb"></i> Next Steps:</h6>
            <ol class="mb-3">
                <li>Use the <strong>Scan</strong> feature to add this image to the database</li>
                <li>Once scanned, return here to get recommendations</li>
            </ol>
            <div class="d-flex gap-2">
                <a href="/scan" class="btn btn-primary">
                    <i class="bi bi-search"></i> Go to Scan Page
                </a>
                <button class="btn btn-outline-secondary" onclick="copyImageName('${imageName}')">
                    <i class="bi bi-clipboard"></i> Copy Image Name
                </button>
            </div>
        </div>
    `;
    errorDiv.style.display = 'block';
}

function copyImageName(imageName) {
    navigator.clipboard.writeText(imageName).then(function() {
        // Show a temporary success message
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-check"></i> Copied!';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');

        setTimeout(function() {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(function(err) {
        console.error('Failed to copy image name: ', err);
    });
}

function getScoreClass(score) {
    if (score >= 0.8) return 'bg-success';
    if (score >= 0.6) return 'bg-warning';
    return 'bg-danger';
}

function getVulnerabilityBadge(vulns) {
    const total = vulns.total || 0;
    const critical = vulns.critical || 0;
    const high = vulns.high || 0;

    if (total === 0) {
        return '<span class="badge bg-success"><i class="bi bi-shield-check"></i> No Vulnerabilities</span>';
    }

    if (critical > 0 || high > 0) {
        return `<span class="badge bg-danger"><i class="bi bi-exclamation-triangle"></i> ${total} Total (${critical + high} Critical/High)</span>`;
    }

    return `<span class="badge bg-warning"><i class="bi bi-info-circle"></i> ${total} Total (Low/Medium)</span>`;
}

function copyDockerCommand(imageName) {
    const command = `docker pull ${imageName}`;
    navigator.clipboard.writeText(command).then(() => {
        showAlert('Docker command copied to clipboard!', 'success');
    }).catch(() => {
        showAlert('Failed to copy to clipboard. Command: ' + command, 'info');
    });
}

function showImageDetails(imageName) {
    console.log('showImageDetails called with:', imageName);

    // Get image details by name to find the image ID
    fetch(`/api/image/${encodeURIComponent(imageName)}`)
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API response:', data);
            if (data.success && data.found && data.image && data.image.id) {
                console.log('Navigating to image ID:', data.image.id);
                // Navigate to image details page
                window.location.href = `/image/${data.image.id}`;
            } else {
                console.log('Image not found. Debug info:', data.debug_info);
                let errorMsg = 'Image details not found in database.';
                if (data.debug_info && data.debug_info.similar_names.length > 0) {
                    errorMsg += ` Found similar: ${data.debug_info.similar_names.join(', ')}`;
                }
                alert(errorMsg);
            }
        })
        .catch(error => {
            console.error('Error fetching image details:', error);
            alert('Unable to load image details. Network error: ' + error.message);
        });
}

function compareImages(sourceImage, targetImage) {
    console.log('compareImages called with:', sourceImage, 'vs', targetImage);

    if (targetImage) {
        // Navigate to compare page with both images pre-selected as URL parameters
        const compareUrl = `/compare?source=${encodeURIComponent(sourceImage)}&target=${encodeURIComponent(targetImage)}`;
        window.location.href = compareUrl;
    } else {
        // Navigate to compare page with only one image pre-selected
        const compareUrl = `/compare?source=${encodeURIComponent(sourceImage)}`;
        window.location.href = compareUrl;
    }
}

// Utility functions
function showLoading(spinner) {
    if (spinner) {
        spinner.style.display = 'inline-block';
    }
}

function hideLoading(spinner) {
    if (spinner) {
        spinner.style.display = 'none';
    }
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showAlert(message, type) {
    // Create a simple alert (you could enhance this with a proper toast library)
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

function displayAnalysisWithNoRecommendations(analyzedImage, analysis, requirement) {
    // Display analysis summary in the no results state
    const noResultsDiv = document.getElementById('noResultsStateAnalysis');

    const languagesText = analysis.languages.map(l => `${l.language} ${l.version || '(version unknown)'}`).join(', ');

    // Get vulnerability info from analysis
    const vulns = analysis.vulnerabilities || {};
    const vulnBadge = getVulnerabilityBadge(vulns);

    noResultsDiv.innerHTML = `
        <!-- Analysis Details -->
        <div class="alert alert-success mb-4">
            <h6><i class="bi bi-check-circle"></i> Analysis Complete</h6>
            <strong>Analyzed Image:</strong> ${analyzedImage}<br>
            <strong>Detected Languages:</strong> ${languagesText}<br>
            <strong>System Packages:</strong> ${analysis.system_packages_count} packages<br>
            <strong>Package Managers:</strong> ${analysis.package_managers_count} detected<br>
            <strong>Total Packages Found:</strong> ${analysis.total_packages}<br>
            <strong>Image Size:</strong> ${formatBytes(analysis.size_bytes || 0)}<br>
            <strong>Security Status:</strong> ${vulnBadge}
        </div>

        <!-- Derived Requirements -->
        <div class="alert alert-info mb-4">
            <h6><i class="bi bi-info-circle"></i> Derived Requirements</h6>
            <strong>Primary Language:</strong> ${requirement.language} ${requirement.version || '(any version)'}<br>
            ${requirement.packages.length > 0 ? `<strong>Packages (first 20):</strong> ${requirement.packages.join(', ')}<br>` : ''}
            <strong>Size:</strong> ${requirement.size_preference} •
            <strong>Security:</strong> ${requirement.security_level}
        </div>

        <!-- No Results Message -->
        <div class="text-center py-4">
            <i class="bi bi-search display-1 text-warning"></i>
            <h5 class="text-warning mt-3">No matching images found</h5>
            <p class="text-muted">We analyzed your image successfully but couldn't find matching alternatives in our database.</p>
            <p class="text-muted">Try adjusting your preferences:</p>
            <ul class="text-muted text-start">
                <li>Increase maximum vulnerabilities allowed</li>
                <li>Change security level to "Standard"</li>
                <li>Select a different size preference</li>
            </ul>
        </div>
    `;
}
</script>
{% endblock %}
